{"version":3,"sources":["../../src/hooks/useAutoDetectAppearance.tsx"],"sourcesContent":["import * as React from 'react';\nimport vkBridge, {\n  AnyReceiveMethodName,\n  AppearanceType,\n  VKBridgeEvent,\n} from '@vkontakte/vk-bridge';\nimport { noop } from '@vkontakte/vkjs';\nimport { resolveAppearance, VKBridgeConfigData } from '../helpers/appearance';\nimport { useDOM } from '../lib/dom';\nimport { matchMediaListAddListener, matchMediaListRemoveListener } from '../lib/matchMedia';\n\nfunction autoDetectAppearanceByBridge(\n  setAppearance: (value: AppearanceType) => void,\n  onDetectAppearanceByBridge: () => void,\n) {\n  function updateAppearance(data: VKBridgeConfigData) {\n    const initialAppearance = resolveAppearance(data);\n\n    if (initialAppearance) {\n      onDetectAppearanceByBridge();\n      setAppearance(initialAppearance);\n    }\n  }\n\n  function bridgeListener(e: VKBridgeEvent<AnyReceiveMethodName>) {\n    const { type, data } = e.detail;\n\n    if (type !== 'VKWebAppUpdateConfig') {\n      return;\n    }\n\n    updateAppearance(data as VKBridgeConfigData);\n  }\n\n  vkBridge.subscribe(bridgeListener);\n  vkBridge.send('VKWebAppGetConfig').then(updateAppearance).catch(console.error);\n\n  return () => vkBridge.unsubscribe(bridgeListener);\n}\n\nfunction autoDetectAppearance(\n  window: Window | undefined,\n  setAppearance: (value: AppearanceType) => void,\n): () => void {\n  const mediaQuery =\n    window && window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)');\n\n  if (mediaQuery === undefined) {\n    return noop;\n  }\n\n  const check = (event: MediaQueryList | MediaQueryListEvent) => {\n    // eslint-disable-next-line no-restricted-properties\n    setAppearance(event.matches ? 'dark' : 'light');\n  };\n\n  check(mediaQuery);\n  matchMediaListAddListener(mediaQuery, check);\n\n  return () => matchMediaListRemoveListener(mediaQuery, check);\n}\n\n/**\n * TODO [>=6]: удалить хук (#5049)\n * @deprecated v5.8.0\n */\nexport const useAutoDetectAppearance = (\n  appearanceProp?: AppearanceType,\n  onDetectAppearanceByBridge?: () => void,\n): AppearanceType => {\n  const { window } = useDOM();\n  const onceDetectAppearanceByBridge = React.useRef(() => {\n    onDetectAppearanceByBridge && onDetectAppearanceByBridge();\n    onceDetectAppearanceByBridge.current = noop;\n  });\n\n  const [appearance, setAppearance] = React.useState<AppearanceType>(() => {\n    if (appearanceProp) {\n      return appearanceProp;\n    }\n\n    const mediaQuery =\n      window && window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)');\n\n    // eslint-disable-next-line no-restricted-properties\n    return mediaQuery?.matches ? 'dark' : 'light';\n  });\n\n  React.useEffect(() => {\n    if (appearanceProp) {\n      setAppearance(appearanceProp);\n      return noop;\n    }\n\n    if (vkBridge.isEmbedded()) {\n      return autoDetectAppearanceByBridge(setAppearance, onceDetectAppearanceByBridge.current);\n    }\n\n    return autoDetectAppearance(window, setAppearance);\n  }, [window, appearanceProp]);\n\n  return appearance;\n};\n"],"names":["React","vkBridge","noop","resolveAppearance","useDOM","matchMediaListAddListener","matchMediaListRemoveListener","autoDetectAppearanceByBridge","setAppearance","onDetectAppearanceByBridge","updateAppearance","data","initialAppearance","bridgeListener","e","detail","type","subscribe","send","then","catch","console","error","unsubscribe","autoDetectAppearance","window","mediaQuery","matchMedia","undefined","check","event","matches","useAutoDetectAppearance","appearanceProp","onceDetectAppearanceByBridge","useRef","current","useState","appearance","useEffect","isEmbedded"],"mappings":";AAAA,YAAYA,WAAW,QAAQ;AAC/B,OAAOC,cAIA,uBAAuB;AAC9B,SAASC,IAAI,QAAQ,kBAAkB;AACvC,SAASC,iBAAiB,QAA4B,wBAAwB;AAC9E,SAASC,MAAM,QAAQ,aAAa;AACpC,SAASC,yBAAyB,EAAEC,4BAA4B,QAAQ,oBAAoB;AAE5F,SAASC,6BACPC,aAA8C,EAC9CC,0BAAsC;IAEtC,SAASC,iBAAiBC,IAAwB;QAChD,IAAMC,oBAAoBT,kBAAkBQ;QAE5C,IAAIC,mBAAmB;YACrBH;YACAD,cAAcI;QAChB;IACF;IAEA,SAASC,eAAeC,CAAsC;QAC5D,IAAuBA,YAAAA,EAAEC,MAAM,EAAvBC,OAAeF,UAAfE,MAAML,OAASG,UAATH;QAEd,IAAIK,SAAS,wBAAwB;YACnC;QACF;QAEAN,iBAAiBC;IACnB;IAEAV,SAASgB,SAAS,CAACJ;IACnBZ,SAASiB,IAAI,CAAC,qBAAqBC,IAAI,CAACT,kBAAkBU,KAAK,CAACC,QAAQC,KAAK;IAE7E,OAAO;eAAMrB,SAASsB,WAAW,CAACV;;AACpC;AAEA,SAASW,qBACPC,MAA0B,EAC1BjB,aAA8C;IAE9C,IAAMkB,aACJD,UAAUA,OAAOE,UAAU,IAAIF,OAAOE,UAAU,CAAC;IAEnD,IAAID,eAAeE,WAAW;QAC5B,OAAO1B;IACT;IAEA,IAAM2B,QAAQ,SAACC;QACb,oDAAoD;QACpDtB,cAAcsB,MAAMC,OAAO,GAAG,SAAS;IACzC;IAEAF,MAAMH;IACNrB,0BAA0BqB,YAAYG;IAEtC,OAAO;eAAMvB,6BAA6BoB,YAAYG;;AACxD;AAEA;;;CAGC,GACD,OAAO,IAAMG,0BAA0B,SACrCC,gBACAxB;IAEA,IAAM,AAAEgB,SAAWrB,SAAXqB;IACR,IAAMS,+BAA+BlC,MAAMmC,MAAM,CAAC;QAChD1B,8BAA8BA;QAC9ByB,6BAA6BE,OAAO,GAAGlC;IACzC;IAEA,IAAoCF,mCAAAA,MAAMqC,QAAQ,CAAiB;QACjE,IAAIJ,gBAAgB;YAClB,OAAOA;QACT;QAEA,IAAMP,aACJD,UAAUA,OAAOE,UAAU,IAAIF,OAAOE,UAAU,CAAC;QAEnD,oDAAoD;QACpD,OAAOD,CAAAA,uBAAAA,iCAAAA,WAAYK,OAAO,IAAG,SAAS;IACxC,QAVOO,aAA6BtC,oBAAjBQ,gBAAiBR;IAYpCA,MAAMuC,SAAS,CAAC;QACd,IAAIN,gBAAgB;YAClBzB,cAAcyB;YACd,OAAO/B;QACT;QAEA,IAAID,SAASuC,UAAU,IAAI;YACzB,OAAOjC,6BAA6BC,eAAe0B,6BAA6BE,OAAO;QACzF;QAEA,OAAOZ,qBAAqBC,QAAQjB;IACtC,GAAG;QAACiB;QAAQQ;KAAe;IAE3B,OAAOK;AACT,EAAE"}