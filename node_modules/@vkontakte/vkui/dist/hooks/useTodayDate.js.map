{"version":3,"sources":["../../src/hooks/useTodayDate.ts"],"sourcesContent":["import * as React from 'react';\nimport { getMillisecondsToTomorrow, isSameDay } from '../lib/date';\nimport { useDOM } from '../lib/dom';\n\n/**\n * Опционально обновляемая дата сегодняшнего дня\n *\n * Дата - сегодня (в соответствии с системным временем)\n *\n * Часы, минуты, секунды, миллисекунды - произвольные\n *\n * @param listenDayChangesForUpdate - флаг по которому определяется, будет ли создаваться подписка на смену календарного дня\n */\nexport function useTodayDate(listenDayChangesForUpdate = false) {\n  const { document, window } = useDOM();\n  const [todayDate, setTodayDate] = React.useState(() => new Date());\n\n  React.useEffect(() => {\n    if (!listenDayChangesForUpdate || !document || !window) {\n      return;\n    }\n\n    let timeout: number | undefined = undefined;\n\n    const recalcTimeout = () => {\n      if (document.visibilityState === 'visible') {\n        const now = new Date();\n\n        const timeToDayChange = getMillisecondsToTomorrow(now);\n\n        // Удаляем старый таймаут\n        window.clearTimeout(timeout);\n\n        // Создаем новый таймаут\n        timeout = window.setTimeout(() => {\n          setTodayDate(now);\n        }, timeToDayChange);\n\n        // Если todayDate не обновился в таймаут - обновить при заходе на вкладку\n        if (!isSameDay(todayDate, now)) {\n          setTodayDate(now);\n        }\n      }\n    };\n\n    recalcTimeout();\n\n    // Создаем слушатель visibilitychange, чтобы предотвратить пропуск обновления стейта после заморозки вкладки\n    // Если человек ее долго не трогал или закрывал крышку ноута и тп\n    // https://developer.chrome.com/blog/page-lifecycle-api/\n    document.addEventListener('visibilitychange', recalcTimeout);\n\n    return () => {\n      window.clearTimeout(timeout);\n      document.removeEventListener('visibilitychange', recalcTimeout);\n    };\n  }, [document, listenDayChangesForUpdate, todayDate, window]);\n\n  return todayDate;\n}\n"],"names":["React","getMillisecondsToTomorrow","isSameDay","useDOM","useTodayDate","listenDayChangesForUpdate","document","window","useState","Date","todayDate","setTodayDate","useEffect","timeout","undefined","recalcTimeout","visibilityState","now","timeToDayChange","clearTimeout","setTimeout","addEventListener","removeEventListener"],"mappings":";AAAA,YAAYA,WAAW,QAAQ;AAC/B,SAASC,yBAAyB,EAAEC,SAAS,QAAQ,cAAc;AACnE,SAASC,MAAM,QAAQ,aAAa;AAEpC;;;;;;;;CAQC,GACD,OAAO,SAASC;QAAaC,4BAAAA,iEAA4B;IACvD,IAA6BF,UAAAA,UAArBG,WAAqBH,QAArBG,UAAUC,SAAWJ,QAAXI;IAClB,IAAkCP,mCAAAA,MAAMQ,QAAQ,CAAC;eAAM,IAAIC;YAApDC,YAA2BV,oBAAhBW,eAAgBX;IAElCA,MAAMY,SAAS,CAAC;QACd,IAAI,CAACP,6BAA6B,CAACC,YAAY,CAACC,QAAQ;YACtD;QACF;QAEA,IAAIM,UAA8BC;QAElC,IAAMC,gBAAgB;YACpB,IAAIT,SAASU,eAAe,KAAK,WAAW;gBAC1C,IAAMC,MAAM,IAAIR;gBAEhB,IAAMS,kBAAkBjB,0BAA0BgB;gBAElD,yBAAyB;gBACzBV,OAAOY,YAAY,CAACN;gBAEpB,wBAAwB;gBACxBA,UAAUN,OAAOa,UAAU,CAAC;oBAC1BT,aAAaM;gBACf,GAAGC;gBAEH,yEAAyE;gBACzE,IAAI,CAAChB,UAAUQ,WAAWO,MAAM;oBAC9BN,aAAaM;gBACf;YACF;QACF;QAEAF;QAEA,4GAA4G;QAC5G,iEAAiE;QACjE,wDAAwD;QACxDT,SAASe,gBAAgB,CAAC,oBAAoBN;QAE9C,OAAO;YACLR,OAAOY,YAAY,CAACN;YACpBP,SAASgB,mBAAmB,CAAC,oBAAoBP;QACnD;IACF,GAAG;QAACT;QAAUD;QAA2BK;QAAWH;KAAO;IAE3D,OAAOG;AACT"}