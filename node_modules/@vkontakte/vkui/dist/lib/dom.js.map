{"version":3,"sources":["../../src/lib/dom.tsx"],"sourcesContent":["import * as React from 'react';\nimport { canUseDOM } from '@vkontakte/vkjs';\nimport { rectToClientRect } from '@vkontakte/vkui-floating-ui/core';\nimport {\n  getNearestOverflowAncestor as getNearestOverflowAncestorLib,\n  getWindow,\n  isHTMLElement,\n} from '@vkontakte/vkui-floating-ui/utils/dom';\n\nexport { getWindow, getNodeScroll } from '@vkontakte/vkui-floating-ui/utils/dom';\n\nexport { canUseDOM, canUseEventListeners, onDOMLoaded } from '@vkontakte/vkjs';\nexport interface DOMContextInterface {\n  /**\n   * @ignore\n   */\n  window?: Window;\n  /**\n   * @ignore\n   */\n  document?: Document;\n}\n\nexport type DOMProps = DOMContextInterface;\n\n/* eslint-disable no-restricted-globals */\nexport const getDOM = () => ({\n  window: canUseDOM ? window : undefined,\n  document: canUseDOM ? document : undefined,\n});\n/* eslint-enable no-restricted-globals */\n\nexport const DOMContext = React.createContext<DOMContextInterface>(getDOM());\n\nexport const useDOM = () => {\n  return React.useContext(DOMContext);\n};\n\n/**\n * В случае, если используется DOMContext, при проверке 'node instanceOf Window' – Window может быть\n * другим объектом.\n */\nexport const isWindow = (\n  node: Element | Window | VisualViewport | undefined | null,\n): node is Window => {\n  return node !== null && node !== undefined && 'navigator' in node;\n};\n\nexport const isBody = (\n  node: Element | Window | VisualViewport | undefined | null,\n): node is HTMLBodyElement => {\n  return node !== null && node !== undefined && 'tagName' in node && node.tagName === 'BODY';\n};\n\nexport const isDocumentElement = (\n  node: Element | Window | VisualViewport | undefined | null,\n): node is HTMLHtmlElement => {\n  return node !== null && node !== undefined && 'tagName' in node && node.tagName === 'HTML';\n};\n\nexport function withDOM<Props>(\n  Component: React.ComponentType<Props & DOMProps>,\n): React.ComponentType<Props> {\n  const WithDOM = (props: Props) => {\n    const dom = useDOM();\n    return <Component {...props} {...dom} />;\n  };\n  return WithDOM;\n}\n\nexport function blurActiveElement(document: Document | undefined) {\n  if (document && document.activeElement) {\n    (document.activeElement as HTMLElement).blur();\n  }\n}\n\nexport const TRANSFORM_DEFAULT_VALUES = ['none', 'initial', 'inherit', 'unset'];\nexport const WILL_CHANGE_DEFAULT_VALUES = ['auto', 'initial', 'inherit', 'unset'];\nexport function getTransformedParentCoords(element: Element) {\n  let parentNode = element.parentNode;\n  while (parentNode !== null) {\n    if (isHTMLElement(parentNode)) {\n      const { transform, willChange } = getComputedStyle(parentNode);\n      if (\n        !TRANSFORM_DEFAULT_VALUES.includes(transform) ||\n        !WILL_CHANGE_DEFAULT_VALUES.includes(willChange)\n      ) {\n        const { x, y } = parentNode.getBoundingClientRect();\n        return { x, y };\n      }\n    }\n    parentNode = parentNode.parentNode;\n  }\n  return { x: 0, y: 0 };\n}\n\nexport const getBoundingClientRect = (node: Element | Window, isFixedStrategy = false) => {\n  const element = isWindow(node) ? node.document.documentElement : node;\n  const clientRect = element.getBoundingClientRect();\n\n  if (isDocumentElement(element)) {\n    /**\n     * Если на странице не используется `html, body { height: 100% }` (или `height: 100vh`), то\n     * `height`, полученный из `document.documentElement.getBoundingClientRect()`, будет возвращать\n     * `scrollHeight`, а не `clientHeight`. Поэтому перебиваем `height` на `clientHeight`.\n     */\n    clientRect.height = element.clientHeight;\n  }\n\n  let offsetX = 0;\n  let offsetY = 0;\n  if (isFixedStrategy) {\n    const { x, y } = getTransformedParentCoords(element);\n    offsetX = x;\n    offsetY = y;\n  }\n\n  return rectToClientRect({\n    x: clientRect.left - offsetX,\n    y: clientRect.top - offsetY,\n    width: clientRect.width,\n    height: clientRect.height,\n  }) as DOMRect;\n};\n\n/**\n * Адаптер над getNearestOverflowAncestor из @floating-ui/utils/dom.\n *\n * document.body подменяем на window, т.к. на document.body нельзя применить скролл.\n */\nexport const getNearestOverflowAncestor = (childEl: Node): HTMLElement | Window | null => {\n  const foundAncestor = getNearestOverflowAncestorLib(childEl);\n\n  return isBody(foundAncestor)\n    ? getWindow(foundAncestor)\n    : isHTMLElement(childEl)\n    ? foundAncestor\n    : null;\n};\n\nexport const getScrollHeight = (node: Element | Window) => {\n  return isWindow(node) ? node.document.documentElement.scrollHeight : node.scrollHeight;\n};\n\nexport const getScrollRect = (node: Element | Window) => {\n  const window = node instanceof Element ? getWindow(node) : node;\n  const scrollElRect = getBoundingClientRect(node);\n\n  const edgeTop = window.scrollY + scrollElRect.top;\n  const edgeBottom = edgeTop + scrollElRect.height;\n  const y: [number, number] = [edgeTop, edgeBottom];\n\n  return {\n    relative: scrollElRect,\n    edges: { y },\n  };\n};\n"],"names":["React","canUseDOM","rectToClientRect","getNearestOverflowAncestor","getNearestOverflowAncestorLib","getWindow","isHTMLElement","getNodeScroll","canUseEventListeners","onDOMLoaded","getDOM","window","undefined","document","DOMContext","createContext","useDOM","useContext","isWindow","node","isBody","tagName","isDocumentElement","withDOM","Component","WithDOM","props","dom","blurActiveElement","activeElement","blur","TRANSFORM_DEFAULT_VALUES","WILL_CHANGE_DEFAULT_VALUES","getTransformedParentCoords","element","parentNode","getComputedStyle","transform","willChange","includes","getBoundingClientRect","x","y","isFixedStrategy","documentElement","clientRect","height","clientHeight","offsetX","offsetY","left","top","width","childEl","foundAncestor","getScrollHeight","scrollHeight","getScrollRect","Element","scrollElRect","edgeTop","scrollY","edgeBottom","relative","edges"],"mappings":"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"}