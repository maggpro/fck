{"version":3,"sources":["../../../src/components/Touch/Touch.tsx"],"sourcesContent":["import * as React from 'react';\nimport { useEventListener } from '../../hooks/useEventListener';\nimport { useExternRef } from '../../hooks/useExternRef';\nimport { useDOM } from '../../lib/dom';\nimport { coordX, coordY, getSupportedEvents, touchEnabled, VKUITouchEvent } from '../../lib/touch';\nimport { useIsomorphicLayoutEffect } from '../../lib/useIsomorphicLayoutEffect';\nimport { HasComponent, HasRootRef } from '../../types';\n\nexport interface TouchProps\n  extends React.AllHTMLAttributes<HTMLElement>,\n    HasRootRef<HTMLElement>,\n    HasComponent {\n  /**\n   * Привязать onEnter и onLeave через pointer-events - работает на disabled-инпутах\n   */\n  usePointerHover?: boolean;\n  useCapture?: boolean;\n  slideThreshold?: number;\n  noSlideClick?: boolean;\n  onEnter?: HoverHandler;\n  onLeave?: HoverHandler;\n  onStart?: TouchEventHandler;\n  onStartX?: TouchEventHandler;\n  onStartY?: TouchEventHandler;\n  onMove?: TouchEventHandler;\n  onMoveX?: TouchEventHandler;\n  onMoveY?: TouchEventHandler;\n  onEnd?: TouchEventHandler;\n  onEndX?: TouchEventHandler;\n  onEndY?: TouchEventHandler;\n  stopPropagation?: boolean;\n}\n\nexport interface Gesture {\n  startX: number;\n  startY: number;\n  startT: Date;\n  duration: number;\n  isPressed: boolean;\n  isY: boolean;\n  isX: boolean;\n  isSlideX: boolean;\n  isSlideY: boolean;\n  isSlide: boolean;\n  clientX: number;\n  clientY: number;\n  shiftX: number;\n  shiftY: number;\n  shiftXAbs: number;\n  shiftYAbs: number;\n}\n\nexport interface TouchEvent extends Gesture {\n  originalEvent: VKUITouchEvent;\n}\n\ntype HoverHandler = (outputEvent: MouseEvent) => void;\nexport type TouchEventHandler = (e: TouchEvent) => void;\nexport type ClickHandler = (e: React.MouseEvent<HTMLElement>) => void;\nexport type DragHandler = (e: React.DragEvent<HTMLElement>) => void;\n\n/**\n * @see https://vkcom.github.io/VKUI/#/Touch\n */\nexport const Touch = ({\n  onStart,\n  onStartX,\n  onStartY,\n  onMove: _onMove,\n  onMoveX,\n  onMoveY,\n  onLeave,\n  onEnter,\n  onEnd: _onEnd,\n  onEndX,\n  onEndY,\n  onClickCapture,\n  usePointerHover,\n  slideThreshold = 5,\n  useCapture = false,\n  Component = 'div',\n  getRootRef,\n  noSlideClick = false,\n  stopPropagation = false,\n  ...restProps\n}: TouchProps) => {\n  const { document } = useDOM();\n  const events = React.useMemo(getSupportedEvents, []);\n  const didSlide = React.useRef(false);\n  const gesture = React.useRef<Partial<Gesture> | null>(null);\n  const handle = (e: VKUITouchEvent, handlers: Array<TouchEventHandler | undefined | false>) => {\n    stopPropagation && e.stopPropagation();\n    handlers.forEach((cb) => {\n      const duration = Date.now() - (gesture.current?.startT?.getTime() ?? 0);\n      cb && cb({ ...(gesture.current as Gesture), duration, originalEvent: e });\n    });\n  };\n\n  const enterHandler = useEventListener(usePointerHover ? 'pointerenter' : 'mouseenter', onEnter);\n  const leaveHandler = useEventListener(usePointerHover ? 'pointerleave' : 'mouseleave', onLeave);\n  const startHandler = useEventListener(\n    events[0],\n    (e: VKUITouchEvent) => {\n      gesture.current = initGesture(coordX(e), coordY(e));\n\n      handle(e, [onStart, onStartX, onStartY]);\n      // 1 line, 2 bad specs, 2 workarounds:\n      subscribe(\n        touchEnabled()\n          ? // Touch events fire on initial target, and won't bubble if its removed\n            // see: #235, #1968, https://stackoverflow.com/a/45760014\n            (e.target as HTMLElement)\n          : // Mouse events fire on the element under pointer, so we lose move / end\n            // if pointer goes outside container.\n            // Can be fixed by PointerEvents' setPointerCapture later\n            document,\n      );\n    },\n    { capture: useCapture, passive: false },\n  );\n  const containerRef = useExternRef(getRootRef);\n\n  useIsomorphicLayoutEffect(() => {\n    const el = containerRef.current;\n    if (el) {\n      enterHandler.add(el);\n      leaveHandler.add(el);\n      startHandler.add(el);\n    }\n  }, [Component]);\n\n  function onMove(e: VKUITouchEvent) {\n    const { isPressed, isX, isY, startX = 0, startY = 0 } = gesture.current ?? {};\n\n    if (isPressed) {\n      const clientX = coordX(e);\n      const clientY = coordY(e);\n\n      // смещения\n      const shiftX = clientX - startX;\n      const shiftY = clientY - startY;\n\n      // абсолютные значения смещений\n      const shiftXAbs = Math.abs(shiftX);\n      const shiftYAbs = Math.abs(shiftY);\n\n      // Если определяем мультитач, то прерываем жест\n      if (!!e.touches && e.touches.length > 1) {\n        return onEnd(e);\n      }\n\n      // если мы ещё не определились\n      if (!isX && !isY) {\n        const willBeX = shiftXAbs >= slideThreshold && shiftXAbs > shiftYAbs;\n        const willBeY = shiftYAbs >= slideThreshold && shiftYAbs > shiftXAbs;\n        const willBeSlidedX = willBeX && (!!onMoveX || !!_onMove);\n        const willBeSlidedY = willBeY && (!!onMoveY || !!_onMove);\n\n        if (gesture.current) {\n          Object.assign(gesture.current, {\n            isY: willBeY,\n            isX: willBeX,\n            isSlideX: willBeSlidedX,\n            isSlideY: willBeSlidedY,\n            isSlide: willBeSlidedX || willBeSlidedY,\n          });\n        }\n      }\n\n      if (gesture.current?.isSlide) {\n        Object.assign(gesture.current, {\n          clientX,\n          clientY,\n          shiftX,\n          shiftY,\n          shiftXAbs,\n          shiftYAbs,\n        });\n\n        handle(e, [\n          _onMove,\n          gesture.current.isSlideX && onMoveX,\n          gesture.current.isSlideY && onMoveY,\n        ]);\n      }\n    }\n  }\n\n  function onEnd(e: VKUITouchEvent) {\n    const { isPressed, isSlide, isSlideX, isSlideY } = gesture.current ?? {};\n\n    if (isPressed) {\n      handle(e, [_onEnd, isSlideY && onEndY, isSlideX && onEndX]);\n    }\n\n    const isTouchEnabled = touchEnabled();\n\n    if (isTouchEnabled && isSlide) {\n      // https://github.com/VKCOM/VKUI/issues/4414\n      // если тач-устройство и был зафиксирован touchmove,\n      // то событие клика не вызывается\n      didSlide.current = false;\n    } else {\n      didSlide.current = Boolean(isSlide);\n    }\n    gesture.current = {};\n\n    // Если это был тач-евент, симулируем отмену hover\n    if (isTouchEnabled) {\n      onLeave && onLeave(e);\n    }\n    unsubscribe();\n  }\n\n  const listenerParams = { capture: useCapture, passive: false };\n  const listeners = [\n    useEventListener(events[1], onMove, listenerParams),\n    useEventListener(events[2], onEnd, listenerParams),\n    useEventListener(events[3], onEnd, listenerParams),\n  ];\n  function subscribe(el: HTMLElement | Document | null | undefined) {\n    if (el) {\n      listeners.forEach((l) => l.add(el));\n    }\n  }\n  function unsubscribe() {\n    listeners.forEach((l) => l.remove());\n  }\n\n  /**\n   * Обработчик событий dragstart\n   * Отменяет нативное браузерное поведение для вложенных ссылок и изображений\n   */\n  const onDragStart = (e: React.DragEvent<HTMLElement>) => {\n    const target = e.target as HTMLElement;\n    if (target.tagName === 'A' || target.tagName === 'IMG') {\n      e.preventDefault();\n    }\n  };\n\n  /**\n   * Обработчик клика по компоненту\n   * Отменяет переход по вложенной ссылке, если был зафиксирован свайп\n   */\n  const postGestureClick: typeof onClickCapture = (e) => {\n    if (!didSlide.current) {\n      return onClickCapture && onClickCapture(e);\n    }\n\n    if (noSlideClick) {\n      e.stopPropagation();\n\n      // https://github.com/VKCOM/VKUI/issues/1977\n      // https://github.com/VKCOM/VKUI/issues/3892\n      e.preventDefault();\n    } else {\n      onClickCapture && onClickCapture(e);\n    }\n\n    didSlide.current = false;\n  };\n\n  return (\n    <Component\n      {...restProps}\n      onDragStart={onDragStart}\n      onClickCapture={postGestureClick}\n      ref={containerRef}\n    />\n  );\n};\n\nfunction initGesture(startX: number, startY: number): Gesture {\n  return {\n    startX,\n    startY,\n    startT: new Date(),\n    duration: 0,\n    isPressed: true,\n    isY: false,\n    isX: false,\n    isSlideX: false,\n    isSlideY: false,\n    isSlide: false,\n    clientX: 0,\n    clientY: 0,\n    shiftX: 0,\n    shiftY: 0,\n    shiftXAbs: 0,\n    shiftYAbs: 0,\n  };\n}\n"],"names":["React","useEventListener","useExternRef","useDOM","coordX","coordY","getSupportedEvents","touchEnabled","useIsomorphicLayoutEffect","Touch","onMove","e","gesture","current","isPressed","isX","isY","startX","startY","clientX","clientY","shiftX","shiftY","shiftXAbs","Math","abs","shiftYAbs","touches","length","onEnd","willBeX","slideThreshold","willBeY","willBeSlidedX","onMoveX","_onMove","willBeSlidedY","onMoveY","Object","assign","isSlideX","isSlideY","isSlide","handle","_onEnd","onEndY","onEndX","isTouchEnabled","didSlide","Boolean","onLeave","unsubscribe","subscribe","el","listeners","forEach","l","add","remove","onStart","onStartX","onStartY","onEnter","onClickCapture","usePointerHover","useCapture","Component","getRootRef","noSlideClick","stopPropagation","restProps","document","events","useMemo","useRef","handlers","cb","duration","Date","now","startT","getTime","originalEvent","enterHandler","leaveHandler","startHandler","initGesture","target","capture","passive","containerRef","listenerParams","onDragStart","tagName","preventDefault","postGestureClick","ref"],"mappings":"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"}