{"version":3,"sources":["../../../src/components/AppRoot/AppRoot.tsx"],"sourcesContent":["import * as React from 'react';\nimport { classNames, noop } from '@vkontakte/vkjs';\nimport { useAdaptivity } from '../../hooks/useAdaptivity';\nimport { useAppearance } from '../../hooks/useAppearance';\nimport { useInsets } from '../../hooks/useInsets';\nimport { useKeyboardInputTracker } from '../../hooks/useKeyboardInputTracker';\nimport { SizeType } from '../../lib/adaptivity';\nimport { useDOM } from '../../lib/dom';\nimport { isRefObject } from '../../lib/isRefObject';\nimport { useIsomorphicLayoutEffect } from '../../lib/useIsomorphicLayoutEffect';\nimport { warnOnce } from '../../lib/warnOnce';\nimport { AppRootContext } from './AppRootContext';\nimport { ElementScrollController, GlobalScrollController } from './ScrollContext';\nimport styles from './AppRoot.module.css';\n\nconst warn = warnOnce('AppRoot');\n\nexport type SafeAreaInsets = {\n  top?: number;\n  right?: number;\n  bottom?: number;\n  left?: number;\n};\n\nconst vkuiSizeXClassNames = {\n  none: 'vkui--sizeX-none',\n  [SizeType.REGULAR]: 'vkui--sizeX-regular',\n};\n\nconst vkuiLayoutClassNames = {\n  card: 'vkui--layout-card',\n  plain: 'vkui--layout-plain',\n};\n\nfunction containerClassNames(layout: AppRootProps['layout'], sizeX: SizeType | 'none'): string[] {\n  const classNames: string[] = [];\n\n  if (layout) {\n    classNames.push(vkuiLayoutClassNames[layout]);\n  }\n\n  if (sizeX !== SizeType.COMPACT) {\n    classNames.push(vkuiSizeXClassNames[sizeX]);\n  }\n\n  return classNames;\n}\n\nconst INSET_CUSTOM_PROPERTY_PREFIX = `--vkui_internal--safe_area_inset_`;\n\n// Используйте classList, но будьте осторожны\n/* eslint-disable no-restricted-properties */\n\nexport interface AppRootProps extends React.HTMLAttributes<HTMLDivElement> {\n  /** Режим встраивания */\n  mode?: 'partial' | 'embedded' | 'full';\n  window?: Window;\n  scroll?: 'global' | 'contain';\n  safeAreaInsets?: SafeAreaInsets;\n  /**\n   * Кастомный root-элемент портала\n   */\n  portalRoot?: HTMLElement | React.RefObject<HTMLElement> | null;\n  /**\n   * Отключает рендер всплывающих компонентов в отдельном контейнере\n   */\n  disablePortal?: boolean;\n  /**\n   * По умолчанию, mode=\"embedded\" переносит систему координат элементов с `position: fixed` на\n   * свой контейнер через `transform: translate3d(0, 0, 0)`.\n   *\n   * Это поведение можно отключить с помощью этого параметра.\n   */\n  disableParentTransformForPositionFixedElements?: boolean;\n  layout?: 'card' | 'plain';\n}\n\n/**\n * @see https://vkcom.github.io/VKUI/#/AppRoot\n */\nexport const AppRoot = ({\n  children,\n  mode = 'full',\n  scroll = 'global',\n  portalRoot: portalRootProp = null,\n  disablePortal,\n  disableParentTransformForPositionFixedElements,\n  className,\n  safeAreaInsets,\n  layout,\n  ...props\n}: AppRootProps) => {\n  const isKeyboardInputActive = useKeyboardInputTracker();\n  const rootRef = React.useRef<HTMLDivElement | null>(null);\n  const [portalRoot, setPortalRoot] = React.useState<HTMLElement | null>(null);\n  const { document } = useDOM();\n  const deprecatedInsetsDisabled = Boolean(safeAreaInsets);\n  const deprecatedInsets = useInsets(deprecatedInsetsDisabled);\n  const insets = safeAreaInsets ? safeAreaInsets : deprecatedInsets;\n  const appearance = useAppearance();\n\n  const { hasPointer, sizeX = 'none' } = useAdaptivity();\n\n  if (process.env.NODE_ENV === 'development') {\n    if (!safeAreaInsets) {\n      // TODO [>=6]: удалить warn\n      warn(\"[@vkontakte/vk-bridge] Интеграция VKUI с @vkontakte/vk-bridge устарела и будет удалена в v6. Используйте хук `useInsets()` из @vkontakte/vk-bridge-react и результат передайте в параметр `safeAreaInsets` (см. https://github.com/VKCOM/VKUI/issues/5049)\"); // prettier-ignore\n    }\n  }\n\n  // setup portal\n  useIsomorphicLayoutEffect(() => {\n    let portal: HTMLElement | null = null;\n    if (portalRootProp) {\n      if (isRefObject(portalRootProp)) {\n        portal = portalRootProp.current;\n      } else {\n        portal = portalRootProp;\n      }\n    }\n    if (!portal) {\n      portal = document!.createElement('div');\n      document!.body.appendChild(portal);\n    }\n    setPortalRoot(portal);\n    return () => {\n      if (!portalRootProp) {\n        portal?.parentElement?.removeChild(portal);\n      }\n    };\n  }, [portalRootProp]);\n\n  // setup root classes\n  useIsomorphicLayoutEffect(() => {\n    if (mode === 'partial') {\n      return noop;\n    }\n\n    const parent = rootRef.current?.parentElement;\n    const classes = ['vkui__root'].concat(mode === 'embedded' ? 'vkui__root--embedded' : []);\n    if (parent) {\n      if (mode === 'embedded' && !disableParentTransformForPositionFixedElements) {\n        parent.style.transform = 'translate3d(0, 0, 0)';\n      }\n      parent.classList.add(...classes);\n    }\n\n    return () => {\n      if (parent) {\n        if (mode === 'embedded' && !disableParentTransformForPositionFixedElements) {\n          parent.style.transform = '';\n        }\n        parent.classList.remove(...classes);\n      }\n    };\n  }, [disableParentTransformForPositionFixedElements]);\n\n  useIsomorphicLayoutEffect(() => {\n    if (mode === 'full') {\n      document!.documentElement.classList.add('vkui');\n\n      return () => {\n        document!.documentElement.classList.remove('vkui');\n      };\n    }\n\n    return undefined;\n  }, [document, mode]);\n\n  // setup insets\n  useIsomorphicLayoutEffect(() => {\n    if (mode === 'partial' || !rootRef.current?.parentElement) {\n      return noop;\n    }\n\n    const parent = rootRef.current.parentElement;\n\n    let key: keyof SafeAreaInsets;\n    for (key in insets) {\n      if (insets.hasOwnProperty(key) && typeof insets[key] === 'number') {\n        const inset = insets[key];\n        parent.style.setProperty(INSET_CUSTOM_PROPERTY_PREFIX + key, `${inset}px`);\n        portalRoot &&\n          portalRoot.style.setProperty(INSET_CUSTOM_PROPERTY_PREFIX + key, `${inset}px`);\n      }\n    }\n\n    return () => {\n      let key: keyof SafeAreaInsets;\n      for (key in insets) {\n        if (insets.hasOwnProperty(key)) {\n          parent.style.removeProperty(INSET_CUSTOM_PROPERTY_PREFIX + key);\n          portalRoot && portalRoot.style.removeProperty(INSET_CUSTOM_PROPERTY_PREFIX + key);\n        }\n      }\n    };\n  }, [insets, portalRoot]);\n\n  // adaptivity handler\n  useIsomorphicLayoutEffect(() => {\n    if (mode === 'partial') {\n      return noop;\n    }\n\n    const classNames = containerClassNames(layout, sizeX);\n\n    const container = mode === 'embedded' ? rootRef.current?.parentElement : document!.body;\n\n    if (!classNames.length || !container) {\n      return noop;\n    }\n\n    container.classList.add(...classNames);\n    return () => {\n      container.classList.remove(...classNames);\n    };\n  }, [sizeX, layout]);\n\n  useIsomorphicLayoutEffect(() => {\n    if (mode !== 'full' || appearance === undefined) {\n      return noop;\n    }\n    document!.documentElement.style.setProperty('color-scheme', appearance);\n\n    return () => document!.documentElement.style.removeProperty('color-scheme');\n  }, [appearance]);\n\n  const ScrollController = React.useMemo(\n    () => (scroll === 'contain' ? ElementScrollController : GlobalScrollController),\n    [scroll],\n  );\n\n  const content = (\n    <AppRootContext.Provider\n      value={{\n        appRoot: rootRef,\n        portalRoot,\n        embedded: mode === 'embedded',\n        keyboardInput: isKeyboardInputActive,\n        mode,\n        disablePortal,\n        layout,\n      }}\n    >\n      <ScrollController elRef={rootRef}>{children}</ScrollController>\n    </AppRootContext.Provider>\n  );\n\n  return mode === 'partial' ? (\n    content\n  ) : (\n    <div\n      ref={rootRef}\n      className={classNames(\n        styles['AppRoot'],\n        hasPointer === undefined\n          ? styles['AppRoot--pointer-none']\n          : !hasPointer && styles['AppRoot--pointer-has-not'],\n        className,\n      )}\n      {...props}\n    >\n      {content}\n    </div>\n  );\n};\n"],"names":["React","classNames","noop","useAdaptivity","useAppearance","useInsets","useKeyboardInputTracker","SizeType","useDOM","isRefObject","useIsomorphicLayoutEffect","warnOnce","AppRootContext","ElementScrollController","GlobalScrollController","warn","vkuiSizeXClassNames","none","REGULAR","vkuiLayoutClassNames","card","plain","containerClassNames","layout","sizeX","push","COMPACT","INSET_CUSTOM_PROPERTY_PREFIX","AppRoot","children","mode","scroll","portalRootProp","portalRoot","disablePortal","disableParentTransformForPositionFixedElements","className","safeAreaInsets","props","isKeyboardInputActive","rootRef","useRef","useState","setPortalRoot","document","deprecatedInsetsDisabled","Boolean","deprecatedInsets","insets","appearance","hasPointer","process","env","NODE_ENV","portal","current","createElement","body","appendChild","parentElement","removeChild","parent","classes","concat","style","transform","classList","add","remove","documentElement","undefined","key","hasOwnProperty","inset","setProperty","removeProperty","container","length","ScrollController","useMemo","content","Provider","value","appRoot","embedded","keyboardInput","elRef","div","ref"],"mappings":"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"}