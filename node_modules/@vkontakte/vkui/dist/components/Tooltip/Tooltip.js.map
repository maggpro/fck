{"version":3,"sources":["../../../src/components/Tooltip/Tooltip.tsx"],"sourcesContent":["import * as React from 'react';\nimport ReactDOM from 'react-dom';\nimport { hasReactNode } from '@vkontakte/vkjs';\nimport { useExternRef } from '../../hooks/useExternRef';\nimport {\n  arrowMiddleware,\n  autoPlacementMiddleware,\n  autoUpdateFloatingElement,\n  checkIsNotAutoPlacement,\n  convertFloatingDataToReactCSSProperties,\n  flipMiddleware,\n  getAutoPlacementAlign,\n  offsetMiddleware,\n  type Placement,\n  type PlacementWithAuto,\n  shiftMiddleware,\n  useFloating,\n  type UseFloatingMiddleware,\n} from '../../lib/floating';\nimport { warnOnce } from '../../lib/warnOnce';\nimport { HasRootRef } from '../../types';\nimport { useNavTransition } from '../NavTransitionContext/NavTransitionContext';\nimport { TOOLTIP_MAX_WIDTH, TooltipBase, type TooltipBaseProps } from '../TooltipBase/TooltipBase';\nimport { tooltipContainerAttr } from './TooltipContainer';\nimport styles from './Tooltip.module.css';\n\n/**\n * Перебиваем `ref`.\n *\n * В оригинальном `React.DOMElement` задаётся `React.LegacyRef<T>`, в котором есть `string`.\n * Когда как `{ ref: \"string\" }` уже давно депрекейтнут.\n */\ninterface DOMElement<P extends React.HTMLAttributes<T> | React.SVGAttributes<T>, T extends Element>\n  extends React.DOMElement<P, T> {\n  ref: React.Ref<T>;\n}\n\nconst isDOMTypeElement = <\n  P extends React.HTMLAttributes<T> | React.SVGAttributes<T>,\n  T extends Element,\n>(\n  element: React.ReactElement,\n): element is DOMElement<P, T> => {\n  return React.isValidElement(element) && typeof element.type === 'string';\n};\n\nconst warn = warnOnce('Tooltip');\n\nexport interface TooltipProps\n  extends Omit<\n    TooltipBaseProps,\n    'arrowCoords' | 'arrowPlacement' | 'getArrowRef' | 'floatingStyle' | 'withArrow'\n  > {\n  /**\n   * **Важно**: если в `children` передан React-компонент, то необходимо убедиться в том, что он поддерживает\n   * свойство `getRootRef`, которое должно возвращаться ссылку на корневой DOM-элемент компонента,\n   * иначе тултип показан не будет. Если передан React-element, то такой проблемы нет.\n   */\n  children: React.ReactElement<HasRootRef<any>> | React.ReactElement;\n  /**\n   * Если передан `false`, то рисуется просто `children`.\n   */\n  isShown?: boolean;\n  alignX?: 'center' | 'left' | 'right';\n  /**\n   * Положение по вертикали (расположение над или под `children`).\n   * Если не задано, позиция по вертикали определятся автоматически\n   */\n  alignY?: 'top' | 'bottom';\n  /**\n   * Сдвиг по горизонтали (относительно портала, в котором рисуется тултип).\n   */\n  offsetX?: number;\n  /**\n   * Сдвиг по вертикали (относительно портала, в котором рисуется тултип).\n   */\n  offsetY?: number;\n  /**\n   * Отображать ли стрелку, указывающую на якорный элемент\n   */\n  arrow?: boolean;\n  /**\n   * Безопасная зона вокруг стрелки, чтобы та не выходила за края контента.\n   */\n  arrowPadding?: number;\n  /**\n   * Сдвиг стрелочки относительно центра дочернего элемента.\n   */\n  cornerOffset?: number;\n  /**\n   * Сдвиг стрелочки относительно ширины тултипа\n   */\n  cornerAbsoluteOffset?: number;\n  /**\n   * Callback, который вызывается при клике по любому месту в пределах экрана.\n   */\n  onClose?: () => void;\n  /**\n   * По умолчанию компонент выберет наилучшее расположение сам. Но его можно задать извне с помощью этого свойства\n   */\n  placement?: PlacementWithAuto;\n}\n\nfunction mapAlignX(x: TooltipProps['alignX']) {\n  switch (x) {\n    case 'left':\n      return 'start';\n    case 'right':\n      return 'end';\n    default:\n      return '';\n  }\n}\nfunction getDefaultPlacement(\n  alignX: TooltipProps['alignX'],\n  alignY: TooltipProps['alignY'],\n): Placement {\n  return [alignY || 'bottom', mapAlignX(alignX || 'left')]\n    .filter((p) => !!p)\n    .join('-') as Placement;\n}\nfunction isVerticalPlacement(placement: PlacementWithAuto) {\n  return placement.startsWith('top') || placement.startsWith('bottom');\n}\n\n/**\n * @see https://vkcom.github.io/VKUI/#/Tooltip\n */\nexport const Tooltip = ({\n  children,\n  isShown: isShownProp = true,\n  offsetX = 0,\n  offsetY = 15,\n  alignX,\n  alignY,\n  onClose,\n  cornerOffset = 0,\n  cornerAbsoluteOffset,\n  arrow = true,\n  arrowPadding = 14,\n  getRootRef,\n  placement: placementProp,\n  maxWidth = TOOLTIP_MAX_WIDTH,\n  ...restProps\n}: TooltipProps) => {\n  const [arrowRef, setArrowRef] = React.useState<HTMLDivElement | null>(null);\n  const [target, setTarget] = React.useState<HTMLElement | null>(null);\n  /* eslint-disable no-restricted-properties */\n  const tooltipContainer = React.useMemo(\n    () => target?.closest<HTMLDivElement>(`[${tooltipContainerAttr}]`),\n    [target],\n  );\n  const { entering } = useNavTransition();\n  const isShown = isShownProp && tooltipContainer && !entering;\n\n  const placement = placementProp || getDefaultPlacement(alignX, alignY);\n  const isNotAutoPlacement = checkIsNotAutoPlacement(placement);\n\n  if (process.env.NODE_ENV === 'development') {\n    const multiChildren = React.Children.count(children) > 1;\n    // Empty children is a noop\n    const primitiveChild = hasReactNode(children) && typeof children !== 'object';\n    (multiChildren || primitiveChild) &&\n      warn(\n        [\n          'children должен быть одним React элементом, получено',\n          multiChildren && 'несколько',\n          primitiveChild && JSON.stringify(children),\n        ]\n          .filter(Boolean)\n          .join(' '),\n        'error',\n      );\n  }\n\n  const floatingPositionStrategy = React.useMemo(\n    () => (target?.style.position === 'fixed' ? 'fixed' : 'absolute'),\n    [target],\n  );\n\n  if (process.env.NODE_ENV === 'development' && target && !tooltipContainer) {\n    throw new Error('Use TooltipContainer for Tooltip outside Panel (see docs)');\n  }\n\n  const memoizedMiddlewares = React.useMemo(() => {\n    const middlewares: UseFloatingMiddleware[] = [\n      offsetMiddleware({\n        crossAxis: offsetX,\n        mainAxis: offsetY,\n      }),\n    ];\n\n    // см. https://floating-ui.com/docs/flip#conflict-with-autoplacement\n    if (isNotAutoPlacement) {\n      middlewares.push(flipMiddleware());\n    } else {\n      middlewares.push(\n        autoPlacementMiddleware({\n          alignment: placement ? getAutoPlacementAlign(placement) : null,\n        }),\n      );\n    }\n\n    middlewares.push(shiftMiddleware());\n\n    // см. https://floating-ui.com/docs/arrow#order\n    if (arrow) {\n      middlewares.push(\n        arrowMiddleware({\n          element: arrowRef,\n          padding: arrowPadding,\n        }),\n      );\n      middlewares.push({\n        name: 'arrowOffset',\n        fn({ placement, middlewareData }) {\n          if (!middlewareData.arrow) {\n            return Promise.resolve({});\n          }\n          if (isVerticalPlacement(placement)) {\n            if (cornerAbsoluteOffset !== undefined) {\n              middlewareData.arrow.x = cornerAbsoluteOffset;\n            } else if (middlewareData.arrow.x !== undefined) {\n              middlewareData.arrow.x += cornerOffset;\n            }\n          } else {\n            if (cornerAbsoluteOffset !== undefined) {\n              middlewareData.arrow.y = cornerAbsoluteOffset;\n            } else if (middlewareData.arrow.y !== undefined) {\n              middlewareData.arrow.y += cornerOffset;\n            }\n          }\n          return Promise.resolve({});\n        },\n      });\n    }\n\n    return middlewares;\n  }, [\n    arrow,\n    arrowRef,\n    arrowPadding,\n    cornerAbsoluteOffset,\n    cornerOffset,\n    offsetX,\n    offsetY,\n    placement,\n    isNotAutoPlacement,\n  ]);\n\n  const {\n    x: floatingDataX,\n    y: floatingDataY,\n    placement: resolvedPlacement,\n    refs,\n    middlewareData: { arrow: arrowCoords },\n  } = useFloating({\n    strategy: floatingPositionStrategy,\n    placement: isNotAutoPlacement ? placement : undefined,\n    middleware: memoizedMiddlewares,\n    whileElementsMounted: autoUpdateFloatingElement,\n  });\n\n  const childRef = isDOMTypeElement<React.HTMLAttributes<HTMLElement>, HTMLElement>(children)\n    ? children.ref\n    : React.isValidElement<HasRootRef<HTMLElement>>(children)\n    ? children.props.getRootRef\n    : null;\n  const patchedRef = useExternRef<HTMLElement>(setTarget, refs.setReference, childRef);\n  const child = React.isValidElement(children)\n    ? React.cloneElement(children, {\n        [isDOMTypeElement(children) ? 'ref' : 'getRootRef']: patchedRef,\n      })\n    : children;\n\n  const tooltipBaseRef = useExternRef<HTMLDivElement>(refs.setFloating, getRootRef);\n  return (\n    <React.Fragment>\n      {child}\n      {isShown &&\n        target != null &&\n        ReactDOM.createPortal(\n          <>\n            <TooltipBase\n              {...restProps}\n              getRootRef={tooltipBaseRef}\n              floatingStyle={convertFloatingDataToReactCSSProperties(\n                floatingPositionStrategy,\n                floatingDataX,\n                floatingDataY,\n              )}\n              withArrow={arrow}\n              arrowCoords={arrowCoords}\n              arrowPlacement={resolvedPlacement}\n              getArrowRef={setArrowRef}\n              maxWidth={maxWidth}\n            />\n            <div className={styles['Tooltip__overlay']} onClickCapture={onClose} />\n          </>,\n          tooltipContainer,\n        )}\n    </React.Fragment>\n  );\n};\n"],"names":["React","ReactDOM","hasReactNode","useExternRef","arrowMiddleware","autoPlacementMiddleware","autoUpdateFloatingElement","checkIsNotAutoPlacement","convertFloatingDataToReactCSSProperties","flipMiddleware","getAutoPlacementAlign","offsetMiddleware","shiftMiddleware","useFloating","warnOnce","useNavTransition","TOOLTIP_MAX_WIDTH","TooltipBase","tooltipContainerAttr","isDOMTypeElement","element","isValidElement","type","warn","mapAlignX","x","getDefaultPlacement","alignX","alignY","filter","p","join","isVerticalPlacement","placement","startsWith","Tooltip","children","isShownProp","isShown","offsetX","offsetY","onClose","cornerOffset","cornerAbsoluteOffset","arrow","arrowPadding","getRootRef","placementProp","maxWidth","restProps","useState","arrowRef","setArrowRef","target","setTarget","tooltipContainer","useMemo","closest","entering","isNotAutoPlacement","process","env","NODE_ENV","multiChildren","Children","count","primitiveChild","JSON","stringify","Boolean","floatingPositionStrategy","style","position","Error","memoizedMiddlewares","middlewares","crossAxis","mainAxis","push","alignment","padding","name","fn","middlewareData","Promise","resolve","undefined","y","strategy","middleware","whileElementsMounted","floatingDataX","floatingDataY","resolvedPlacement","refs","arrowCoords","childRef","ref","props","patchedRef","setReference","child","cloneElement","tooltipBaseRef","setFloating","Fragment","createPortal","floatingStyle","withArrow","arrowPlacement","getArrowRef","div","className","onClickCapture"],"mappings":"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"}